-- ## KABEL ## -- Query para gerar o faturamento / devolução / recusa - Elaborado por.: roberto.volkmann - 21/09/2018

DECLARE @DataIni AS VARCHAR(8), @DataFim AS VARCHAR(8)
SET @DataIni='20130101'
SET @DataFim='20241231'

SELECT --DISTINCT
UPPER(DB_NAME()) as [Empresa],
[COD] as [CodCliente],
[RAZÃO_SOCIAL] as [Razão Social],
[PERIODO] as [Período],
[DT_EMISSAO] as [Emissão],
UPPER([COD_PRODUTO]) as [Cod_Produto],
[TXT_PRODUTO] as [Txt_Produto],
GRUPO as CCusto,
[SEG] as [Seg],
[NOME] as [Resumido],
[NFISCAL] as [N.Fiscal],
[CIDADE] as [Cidade],
[TP_VENDA] as [Tipo Venda],
[TIPO_PRODUTO] as [Tipo Produto],
[QUANTIDADE] as [Quantidade],
[VLR_UNITÁRIO] as [Vlr_Unit],
[VLR_RECEITA_BRUTA] as [Vlr_Bruto],
[DEVOLUÇÃO] as [Devolução],
[VLR_ICMS] as [Vlr_ICMS],
[VLR_IPI] as [Vlr_IPI],
[VLR_PIS] as [Vlr_PIS],
[VLR_COFINS] as [Vlr_COFINS],
IsNull([REV.P], 'XX') as [Rev.Pr],
IsNull([REV.O], 'XXX') as [Rev.Or],
CFOP,
CLAS, 
ORG
FROM(
-- ## MAPA DO FATURAMENTO ## --
SELECT DISTINCT NFC.CLI AS COD, --CASE WHEN INF.ITEM >= 'A' AND NFC.CLI < '999' THEN NFC.CLI ELSE PRO.RESUCLI END AS COD,
       CASE WHEN (CLI.RASSOC IS NULL) THEN FRN.RASSOC ELSE RTrim(CLI.RASSOC) END AS RAZÃO_SOCIAL,
       DateAdd(MM, DateDiff(MM, -1, NFC.EMI), -1) AS PERIODO,
       NFC.EMI AS DT_EMISSAO,
	   INN.NITEM,
       INF.ITEM AS COD_PRODUTO,
       EST.DESCRI AS TXT_PRODUTO,
       CASE WHEN (CLI.SEGMENTO IS NULL) THEN 'OUT' ELSE RTrim(CLI.SEGMENTO) END AS SEG,
       CASE WHEN NFC.CLI <= '999' THEN CLI.LOCAL_CONSUMOMP ELSE FRN.RESUMO END AS NOME,
       Cast(NFC.NUMERO AS VARCHAR) AS NFISCAL,
       CASE WHEN (CLI.CIDADE IS NULL) THEN Upper(RTrim(FRN.CIDADE)) ELSE Upper(RTrim(CLI.CIDADE)) END AS CIDADE,
       CASE
           WHEN EST.FAMILIA IN ('4101') THEN 'GIGA'
		   WHEN CLA.MATERIA_PRIMA = 'S' OR INF.ITEM <= '99999999' OR EST.FAMILIA = '4114' THEN 'REVENDA MP'
		   WHEN INF.CFOP In ('5102', '6102') THEN 'MANUFATURA'           
		   WHEN EST.FAMILIA IN ('90','99') OR EST.FAMILIA IN ('91') OR INF.CFOP Not In ('5102', '6102') THEN 'MANUFATURA'
           ELSE 'OUTROS' END AS TP_VENDA,
	   CASE WHEN CLA.MATERIA_PRIMA = 'S' OR INF.ITEM <= '99999999' OR EST.FAMILIA = '4114' THEN 'REVENDA MP' ELSE UPPER(ISNULL(TPM.DESCRICAO, EST.CST_MODELO)) END AS TIPO_PRODUTO,
       CASE WHEN OPE.DESCRICAO LIKE '%COMPL%' THEN 0 ELSE IsNull(INF.QTDE, 0) END AS QUANTIDADE,
       IsNull(INF.VALOR, 0) AS VLR_UNITÁRIO,
       --IsNull(INF.LIQUIDO, 0) + IsNull(INF.IPI_VALOR, 0) + IsNull(INF.VALOR_EXTRA, 0) AS VLR_RECEITA_BRUTA,
       IsNull(TOTIPI, 0) AS VLR_RECEITA_BRUTA,
       0 AS DEVOLUÇÃO,
       IsNull(INF.ICMS_VALOR, 0) AS VLR_ICMS,
       IsNull(INF.IPI_VALOR, 0) AS VLR_IPI,
       IsNull(INF.PIS_VALOR, 0) AS VLR_PIS,
       IsNull(INF.COFINS_VALOR, 0) AS VLR_COFINS,
       CASE WHEN INN.REVISAO IS NULL THEN CASE WHEN
		(SELECT Max(PRO.REVISAO) FROM PROCESSO PRO With(NoLock) WHERE PRO.NUMPEC = INN.PECA) IS NULL THEN 'XX' ELSE
        (SELECT Max(PRO.REVISAO) FROM PROCESSO PRO With(NoLock) WHERE PRO.NUMPEC = INN.PECA) END ELSE INN.REVISAO END AS [REV.P],
	   CASE WHEN INN.REV_ORC IS NULL THEN 
		(SELECT OLI.REVISAO FROM ORCALISE OLI With(NoLock) WHERE INF.ITEM = OLI.CODKAB AND NFC.CLI = OLI.CODCLI AND OLI.STATUS = 'A') 
		ELSE INN.REV_ORC END AS [REV.O],
	   INN.R_E_C_N_O_ AS IT_RECNO,	
       INF.CFOP AS CFOP,
       EST.CST_COD_CLASSEMAT AS CLAS,
       'FAT' AS ORG,
	   CASE WHEN INF.ITEM < 'A' THEN '11501002596' 
			WHEN EST.CST_COD_CLASSEMAT = '18' THEN EST.GRUPO
			ELSE IsNull(CLI.GRUPO, FRN.GRUPO) END AS GRUPO

FROM CT_CABLANCAMENTOS CTB With(NoLock)
	INNER JOIN CT_LANCAMENTOS CTL With(NoLock) ON CTL.NLANC = CTB.NLANC
	LEFT OUTER JOIN NOTAFISC NFC With(NoLock) ON CTB.RECNO_NOTAFISC = NFC.R_E_C_N_O_
	LEFT OUTER JOIN ITENNOTA INN With(NoLock) ON INN.NOTA = NFC.NOTA
	INNER JOIN ITENNOTA_IMP INF With(NoLock) ON INN.R_E_C_N_O_ = INF.RECNO_ITEM
	INNER JOIN ESTOQUE EST With(NoLock) ON INF.ITEM = EST.CODIGO
	LEFT JOIN CLIENTES CLI With(NoLock) ON NFC.CLI = CLI.CODIGO
	LEFT JOIN FORNECED FRN With(NoLock) ON NFC.CLI = FRN.CODIGO
	INNER JOIN CT_OPERACAO OPE With(NoLock) ON INN.CT_OPERACAO = OPE.CODIGO
	LEFT JOIN ORCALISE ORL With(NoLock) ON INF.ITEM = ORL.CODKAB AND INN.REV_ORC = ORL.REVISAO
	LEFT JOIN CST_TIPO_MAQUINA TPM With(NoLock) ON ORL.CST_TIPO_PRODUTO = TPM.CODIGO
	LEFT JOIN GRUPOE GPE With(NoLock) ON EST.FAMILIA = GPE.GRUPO
	LEFT JOIN CLASSE CLA With(NoLock) ON EST.CATEGORIA = CLA.CLASSE
    LEFT JOIN PROCESSO PRO With(NoLock) ON INF.ITEM = PRO.NUMPEC AND PRO.ATIVO = 'S'
WHERE CTL.COD_CONTA IN ('1658','2264','2703','1662','2123','2265','2124')
  AND NFC.SITUACAO = 'IMPRESSA'
  AND INN.CFOP NOT IN ('6949','5949','6902')
  AND INN.CONSIGNADA <> 'S'
--  AND NFC.EMI BETWEEN '20220201' AND '20220228'
--  AND Cast(NFC.NUMERO AS VARCHAR) = '189703'
--  ORDER BY 5

Union All  -- ## RECUSA DE VENDAS ## --

SELECT CASE WHEN CLI.LOCAL_CONSUMOMP = 'AGCO' THEN LEFT(NF.CLI, 3) ELSE NF.CLI END AS COD,
       CASE WHEN (CLI.RASSOC IS NULL) THEN FR.RASSOC ELSE RTrim(CLI.RASSOC) END AS RAZÃO_SOCIAL,
       DateAdd(MM, DateDiff(MM, -1, NF.EMI), -1) AS PERIODO,
       NF.EMI AS DT_EMISSAO,
	   0 AS NITEM,
       TN.ITEM AS COD_PRODUTO,
       ES.DESCRI AS TXT_PRODUTO,
       CASE WHEN (CLI.SEGMENTO IS NULL) THEN 'OUT' ELSE RTrim(CLI.SEGMENTO) END AS SEG,
       CASE WHEN NF.CLI <= '999' THEN CLI.LOCAL_CONSUMOMP ELSE Upper(FR.RESUMO) END AS NOME,
       Cast(NF.NUMERO AS VARCHAR) AS NFISCAL,
       CASE WHEN (CLI.CIDADE IS NULL) THEN Upper(RTrim(FR.CIDADE)) ELSE Upper(RTrim(CLI.CIDADE)) END AS CIDADE,
       CASE WHEN ES.FAMILIA IN ('4101') THEN 'GIGA'
           WHEN ES.FAMILIA IN ('90') OR ES.FAMILIA IN ('91') THEN 'MANUFATURA'
           WHEN CLA.MATERIA_PRIMA = 'S' OR ES.CATEGORIA = '50' OR ES.FAMILIA IN ('4114', '0910') THEN 'REVENDA MP'
	       WHEN TN.CFOP In ('1949', '2949') THEN 'MANUFATURA'
           WHEN TN.ITEM >= 'A' THEN 'MANUFATURA' 
           ELSE 'OUTROS'
       END AS TP_VENDA,
	   UPPER(ISNULL(TPM.DESCRICAO, ES.CST_MODELO)) AS TIPO_PRODUTO,
       IsNull(TN.QTDE, 0) * -1 AS QUANTIDADE,
       IsNull(TN.VALOR, 0) AS VLR_UNITÁRIO,
       0 VLR_RECEITA_BRUTA,
       (IsNull(TN.LIQUIDO, 0) + IsNull(TN.IPI_VALOR, 0) + IsNull(TN.VALOR_EXTRA, 0)) *-1 AS DEVOLUÇÃO,
       IsNull(TN.ICMS_VALOR, 0) *-1 AS VLR_ICMS,
       IsNull(TN.IPI_VALOR, 0) *-1 AS VLR_IPI,
       IsNull(TN.PIS_VALOR, 0) *-1 AS VLR_PIS,
       IsNull(TN.COFINS_VALOR, 0) *-1 AS VLR_COFINS,
       CASE WHEN IT.REVISAO IS NULL THEN CASE
			WHEN (SELECT Max(PRO.REVISAO) FROM PROCESSO PRO With(NoLock) WHERE PRO.NUMPEC = IT.PECA) IS NULL THEN 'XX' ELSE
                 (SELECT Max(PRO.REVISAO) FROM PROCESSO PRO With(NoLock) WHERE PRO.NUMPEC = IT.PECA) END ELSE IT.REVISAO
       END AS [REV.P],
       CASE WHEN IT.REV_ORC IS NULL THEN 
				(SELECT OQ.REVISAO FROM ORCALISE OQ With(NoLock) WHERE OQ.CODKAB = IT.PECA AND OQ.CODCLI = NF.CLI AND OQ.STATUS = 'A')
				ELSE IT.REV_ORC END AS [REV.O],
       IT.R_E_C_N_O_ AS IT_RECNO,
       TN.CFOP AS CFOP,
       ES.CST_COD_CLASSEMAT AS CLAS,
       'REC' AS ORG,
	   CASE WHEN TN.ITEM < 'A' THEN '11501002596' ELSE IsNull(CLI.GRUPO, FR.GRUPO) END AS GRUPO
FROM CT_CABLANCAMENTOS CT With(NoLock)
	INNER JOIN CT_LANCAMENTOS CL With(NoLock) ON CL.NLANC = CT.NLANC
	LEFT OUTER JOIN NOTAFISC NF With(NoLock) ON CT.RECNO_NOTAFISC = NF.R_E_C_N_O_
	LEFT OUTER JOIN ITENNOTA IT With(NoLock) ON IT.NOTA = NF.NOTA
	INNER JOIN ITENNOTA_IMP TN With(NoLock) ON IT.R_E_C_N_O_ = TN.RECNO_ITEM
	INNER JOIN ESTOQUE ES With(NoLock) ON TN.ITEM = ES.CODIGO
	LEFT JOIN CLIENTES CLI With(NoLock) ON NF.CLI = CLI.CODIGO
	LEFT JOIN FORNECED FR With(NoLock) ON NF.CLI = FR.CODIGO
	INNER JOIN CT_OPERACAO OPE With(NoLock) ON IT.CT_OPERACAO = OPE.CODIGO
	LEFT JOIN ORCALISE OC With(NoLock) ON TN.ITEM = OC.CODKAB AND IT.REV_ORC = OC.REVISAO
	LEFT JOIN CST_TIPO_MAQUINA TPM With(NoLock) ON OC.CST_TIPO_PRODUTO = TPM.CODIGO
	LEFT JOIN GRUPOE GPE With(NoLock) ON ES.FAMILIA = GPE.GRUPO
	LEFT JOIN CLASSE CLA With(NoLock) ON ES.CATEGORIA = CLA.CLASSE
WHERE CL.COD_CONTA IN ('1665', '2846')
  AND NF.SITUACAO = 'IMPRESSA'
  AND IT.CFOP NOT IN ('1902', '2902')
  AND IT.CONSIGNADA <> 'S'

Union All  -- ## DEVOLUÇÃO DE VENDA ## --

SELECT CASE WHEN HST.ITEM >= 'A' THEN EST.CLIENTE ELSE HST.FORNECE END AS COD,
       CASE WHEN (FORN.RASSOC IS NULL) THEN CLI.RASSOC ELSE RTrim(FORN.RASSOC) END AS [RAZÃO_SOCIAL],
       DateAdd(MM, DateDiff(MM, -1, HST.DTENT), -1) AS PERIODO,
       HST.DTENT AS DT_EMISSAO,
	   0 AS NITEM,
       HST.ITEM AS Cod_Produto,
       EST.DESCRI AS Txt_Produto,
       CASE WHEN (CLI.SEGMENTO IS NULL) THEN 'OUT' ELSE RTrim(CLI.SEGMENTO) END AS Seg,
       CASE WHEN PRO.RESUCLI <= '999' THEN CLI.LOCAL_CONSUMOMP ELSE FORN.RESUMO END AS NOME,
       Cast(HST.NFISCAL AS VARCHAR) AS NFISCAL,
       FORN.CIDADE AS Cidade,
       CASE WHEN EST.FAMILIA IN ('4101') THEN 'GIGA'
           WHEN EST.FAMILIA IN ('90') OR EST.FAMILIA IN ('91') THEN 'MANUFATURA'
           WHEN CLA.MATERIA_PRIMA = 'S' THEN 'REVENDA MP' 
           WHEN HST.ITEM >= 'A' THEN 'MANUFATURA' 
           ELSE 'OUTROS'
       END AS TP_VENDA,
	   UPPER(ISNULL(TPM.DESCRICAO, EST.CST_MODELO)) AS TIPO_PRODUTO,
       IsNull(HST.QTENT, 0) * -1 AS Quantidade,
       (HST.VALOR + HST.CT_IPI) AS VLR_UNITÁRIO,
       0 AS VLR_RECEITA_BRUTA,
       (IsNull(HP.TOTIPI, 0) + IsNull(HP.VALOR_EXTRA, 0)) * -1 AS Devolução,
       IsNull(HP.ICMS_VALOR, 0) * -1 AS Vlr_ICMS,
       IsNull(HP.IPI_VALOR, 0) * -1 AS Vlr_IPI,
       IsNull(HP.PIS_VALOR, 0) * -1 AS Vlr_PIS,
       IsNull(HP.COFINS_VALOR, 0) * -1 AS Vlr_COFINS,
       PRO.REVISAO AS [REV.P],
       ORL.REVISAO AS [REV.O],
       'XXXX' AS IT_RECNO,
       HST.CFOP AS CFOP,
       EST.CST_COD_CLASSEMAT AS CLAS,
       'DEV' AS ORG,
	   CASE WHEN HST.ITEM < 'A' THEN '11501002596' ELSE IsNull(CLI.GRUPO, FORN.GRUPO) END AS GRUPO
FROM HISTLISE HST With(NoLock)
	INNER JOIN ESTOQUE EST With(NoLock) ON HST.ITEM = EST.CODIGO
	LEFT JOIN PROCESSO PRO With(NoLock) ON HST.ITEM = PRO.NUMPEC AND PRO.ATIVO = 'S'
	LEFT JOIN FORNECED FORN With(NoLock) ON HST.FORNECE = FORN.CODIGO
	LEFT JOIN CLIENTES CLI With(NoLock) ON EST.CLIENTE = CLI.CODIGO
	LEFT JOIN CT_OPERACAO_CONTA OPER With(NoLock) ON HST.CT_OPERACAO = OPER.CODIGO
	INNER JOIN HISTLISE_IMP HP With(NoLock) ON HST.RECNO_NOTA = HP.RECNO_NOTA AND HP.ITEM = HST.ITEM AND HP.RECNO_ITEM = HST.R_E_C_N_O_
	LEFT JOIN GRUPOE GPE With(NoLock) ON EST.FAMILIA = GPE.GRUPO
	LEFT JOIN CLASSE CLA With(NoLock) ON EST.CATEGORIA = CLA.CLASSE
	LEFT JOIN ORCALISE ORL With(NoLock) ON HST.ITEM = ORL.CODKAB AND ORL.STATUS = 'A' AND PRO.RESUCLI = ORL.CODCLI
	LEFT JOIN CST_TIPO_MAQUINA TPM With(NoLock) ON ORL.CST_TIPO_PRODUTO = TPM.CODIGO
WHERE HST.EFETUADOENTR = 'S'
  AND OPER.COD_CONTA = '1665'
) AS Tb   	
WHERE ([DT_EMISSAO] BETWEEN @DataIni AND @DataFim)  
--And [NFISCAL] In ('212241', '212288', '212289', '211751', '212290')
ORDER BY 1, 2, 5
